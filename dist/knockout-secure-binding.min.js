/*! knockout-secure-binding - v0.5.1 - 2014-10-07
 *  https://github.com/brianmhunt/knockout-secure-binding
 *  Copyright (c) 2013 - 2014 Brian M Hunt; License: MIT */
!function(t){"function"==typeof define&&define.amd?define(["knockout","exports"],t):t(ko)}(function(t,e,n){function r(t){return t instanceof l||t instanceof g?t.get_value():t}function i(t,e){if(!t)return t;var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=e(t[r],r,t));return n}function o(t){var e=(w?t.text:t.nodeValue).match(y);return e?e[1]:null}function s(t){return t>="A"&&"Z">=t||t>="a"&&"z">=t||t>="0"&&9>=t||"_"===t||"$"===t}function u(e){new t.bindingProvider;e=e||{},this.attribute=e.attribute||"data-sbind",this.noVirtualElements=e.noVirtualElements||!1,this.globals=e.globals||{},this.bindings=e.bindings||t.bindingHandlers}function h(e){t.utils.extend(this.bindings,e)}function c(e){var n;return e.nodeType===e.ELEMENT_NODE?e.getAttribute(this.attribute)||t.components.getComponentNameForNode(e):e.nodeType===e.COMMENT_NODE?this.noVirtualElements?!1:(n=(""+e.nodeValue||e.text).trim(),0===n.indexOf("ko ")):void 0}function a(t){switch(t.nodeType){case t.ELEMENT_NODE:return t.getAttribute(this.attribute);case t.COMMENT_NODE:return o(t);default:return null}}function f(t){return t()}function p(e,n){var r=n.parse(e.getAttribute("params"));if(!r||0===Object.keys(r).length)return{$raw:{}};var o=i(r,f),s=i(o,t.unwrap);return s.hasOwnProperty("$raw")||(s.$raw=o),s}function d(e,n){var r,i={},o=new x(e,n,this.globals),s=this.getBindingsString(e);if(e.nodeType===e.ELEMENT_NODE&&(r=t.components.getComponentNameForNode(e)),s&&(i=o.parse(s||"")),r){if(i.component)throw new Error("Cannot use a component binding on custom elements");var u={name:r,params:p(e,o)};i.component=function(){return u}}return i}var l,g,x,v,w=document&&"<!--test-->"===document.createComment("test").text,y=w?/^<!--\s*ko(?:\s+([\s\S]+))?\s*-->$/:/^\s*ko(?:\s+([\s\S]+))?\s*$/;return l=function(){function t(t,e,n){this.token=e,this.dereferences=n,this.parser=t}return t.prototype.lookup_value=function(t){var e=this.token,n=this.parser,i=n.context,o=i.$data||{},s=n.globals||{};if(t)return r(t)[e];switch(e){case"$element":return n.node;case"$context":return i;case"$data":return o}return o[e]||i[e]||s[e]},t.prototype.dereference=function(t){var e,n,i,o,s=this.dereferences||[],u=this.parser,h=u.context||{},c=h.$data||{},a={$context:h,$data:c,globals:u.globals||{},$element:u.node};for(i=0,o=s.length;o>i;++i)e=s[i],e===!0?(t=t.call(n||a),n=t):(n=t,t=t[r(e)]);return t},t.prototype.get_value=function(t){return this.dereference(this.lookup_value(t))},t.prototype.set_value=function(t){var e,n,i,o=this.parser,s=o.context,u=s.$data||{},h=o.globals||{},c=this.dereferences||[],a=this.token;if(Object.hasOwnProperty.call(u,a))i=u;else if(Object.hasOwnProperty.call(s,a))i=s;else{if(!Object.hasOwnProperty.call(h,a))throw new Error("Identifier::set_value -- The property '"+a+"' does not exist on the $data, $context, or globals.");i=h}for(n=c.length,0===n&&(i[a]=t),i=i[a],e=0;n-1>e;++e)a=c[e],i=a===!0?i():i[r(a)];if(c[e]===!0)throw new Error("Cannot assign a value to a function.");i[r(c[e])]=t},t}(),v=function(){function e(t,e,n){this.lhs=t,this.op=e,this.rhs=n}var n={"!":function(t,e){return!e},"!!":function(t,e){return!!e},"*":function(t,e){return t*e},"/":function(t,e){return t/e},"%":function(t,e){return t%e},"+":function(t,e){return t+e},"-":function(t,e){return t-e},"<":function(t,e){return e>t},"<=":function(t,e){return e>=t},">":function(t,e){return t>e},">=":function(t,e){return t>=e},"==":function(t,e){return t===e},"!=":function(t,e){return t!==e},"===":function(t,e){return t===e},"!==":function(t,e){return t!==e},"&":function(t,e){return t&e},"^":function(t,e){return t^e},"|":function(t,e){return t|e},"&&":function(t,e){return t&&e},"||":function(t,e){return t||e}};return n["!"].precedence=4,n["!!"].precedence=4,n["*"].precedence=5,n["/"].precedence=5,n["%"].precedence=5,n["+"].precedence=6,n["-"].precedence=6,n["<"].precedence=8,n["<="].precedence=8,n[">"].precedence=8,n[">="].precedence=8,n["=="].precedence=9,n["!="].precedence=9,n["==="].precedence=9,n["!=="].precedence=9,n["&"].precedence=10,n["^"].precedence=11,n["|"].precedence=12,n["&&"].precedence=13,n["||"].precedence=14,e.operators=n,e.prototype.get_leaf_value=function(n,r){if("function"==typeof n)return t.unwrap(n());if("object"!=typeof n)return r?r[n]:n;if(n instanceof l||n instanceof g)return t.unwrap(n.get_value(r));if(n instanceof e)return n.get_node_value(r);throw new Error("Invalid type of leaf node: "+n)},e.prototype.get_node_value=function(){return this.op(this.get_leaf_value(this.lhs),this.get_leaf_value(this.rhs))},e}(),g=function(){function t(t){this.nodes=t,this.root=this.build_tree(t)}return t.operators=v.operators,t.Node=v,t.prototype.build_tree=function(t){var e,n,r,i;for(n=e=new v(t.shift(),t.shift(),t.shift());t&&(r=t.shift(),i=t.shift(),r);)r.precedence>e.op.precedence?(e=new v(e,r,i),n=e):(n.rhs=new v(n.rhs,r,i),n=n.rhs);return e},t.prototype.get_value=function(){return this.root||(this.root=this.build_tree(this.nodes)),this.root.get_node_value()},t}(),x=function(){function e(t,e,n){this.node=t,this.context=e,this.globals=n||{}}var r={"'":"'",'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"	"},i=g.operators;return e.Expression=g,e.Identifier=l,e.Node=v,e.prototype.white=function(){for(var t=this.ch;t&&" ">=t;)t=this.next();return t},e.prototype.next=function(t){return t&&t!==this.ch&&this.error("Expected '"+t+"' but got '"+this.ch+"'"),this.ch=this.text.charAt(this.at),this.at+=1,this.ch},e.prototype.error=function(t){throw{name:"SyntaxError",message:t,at:this.at,text:this.text}},e.prototype.name=function(){var t="";for(this.white(),ch=this.ch;ch;){if(":"===ch||" ">=ch||","===ch)return t;t+=ch,ch=this.next()}return t},e.prototype.number=function(){var t,e="",n=this.ch;for("-"===n&&(e="-",n=this.next("-"));n>="0"&&"9">=n;)e+=n,n=this.next();if("."===n)for(e+=".",n=this.next();n&&n>="0"&&"9">=n;)e+=n,n=this.next();if("e"===n||"E"===n)for(e+=n,n=this.next(),("-"===n||"+"===n)&&(e+=n,n=this.next());n>="0"&&"9">=n;)e+=n,n=this.next();return t=+e,isFinite(t)?t:void error("Bad number")},e.prototype.object_add_value=function(t,e,n){n instanceof l||n instanceof g?Object.defineProperty(t,e,{get:function(){return n.get_value()},enumerable:!0}):t[e]=n},e.prototype.object=function(){var t,e={},n=this.ch;if("{"===n){if(this.next("{"),n=this.white(),"}"===n)return n=this.next("}"),e;for(;n;){if(t='"'===n||"'"===n?this.string():this.name(),this.white(),n=this.next(":"),Object.hasOwnProperty.call(e,t)&&this.error('Duplicate key "'+t+'"'),this.object_add_value(e,t,this.expression()),n=this.white(),"}"===n)return n=this.next("}"),e;this.next(","),n=this.white()}}this.error("Bad object")},e.prototype.read_string=function(t){for(var e,n,i,o="",s=this.next();s;){if(s===t)return s=this.next(),o;if("\\"===s)if(s=this.next(),"u"===s){for(i=0,n=0;4>n&&(e=parseInt(s=this.next(),16),isFinite(e));n+=1)i=16*i+e;o+=String.fromCharCode(i)}else{if("string"!=typeof r[s])break;o+=r[s]}else o+=s;s=this.next()}this.error("Bad string")},e.prototype.string=function(){var t=this.ch;return'"'===t?this.read_string('"'):"'"===t?this.read_string("'"):void this.error("Bad string")},e.prototype.array=function(){var t=[],e=this.ch;if("["===e){if(e=this.next("["),this.white(),"]"===e)return e=this.next("]"),t;for(;e;){if(t.push(this.expression()),e=this.white(),"]"===e)return e=this.next("]"),t;this.next(","),e=this.white()}}this.error("Bad array")},e.prototype.value=function(){var t;switch(this.white(),t=this.ch){case"{":return this.object();case"[":return this.array();case'"':case"'":return this.string();case"-":return this.number();default:return t>="0"&&"9">=t?this.number():this.identifier()}},e.prototype.operator=function(){for(var t,e="",n=this.white();n&&!(s(n)||" ">=n||""===n||'"'===n||"'"===n||"{"===n||"["===n||"("===n);)e+=n,n=this.next();return""!==e&&(t=i[e],t||this.error("Bad operator: '"+e+"'.")),t},e.prototype.expression=function(){for(var t,e=[],r=this.white();r&&(op=this.operator(),op&&(e.push(n),e.push(op)),"("===r?(this.next(),e.push(this.expression()),this.next(")")):(t=this.value(),e.push(t)),r=this.white(),":"!==r&&"}"!==r&&","!==r&&"]"!==r&&")"!==r&&""!==r);)op=this.operator(),op&&e.push(op),r=this.white();return 0===e.length?n:1===e.length?e[0]:new g(e)},e.prototype.dereference=function(){for(var t,e=this.white();e;){if("("===e)return this.next("("),this.white(),this.next(")"),!0;if("["===e)return this.next("["),t=this.expression(),this.white(),this.next("]"),t;if("."===e){for(t="",this.next("."),e=this.white();e&&s(e);)t+=e,e=this.next();return t}break}},e.prototype.identifier=function(){var t,e,r="",i=[];for(t=this.white();t&&s(t);)r+=t,t=this.next();switch(r){case"true":return!0;case"false":return!1;case"null":return null;case"undefined":return void 0}for(;t&&(e=this.dereference(),e!==n);)i.push(e);return new l(this,r,i)},e.prototype.bindings=function(){for(var t,e,n={},r=this.ch;r;)t=this.name(),e=this.white(),e&&","!==e?(r=this.next(":"),n[t]=this.expression(),this.white(),r=this.ch?this.next(","):""):(r=e?this.next(","):"",n[t]=null);return n},e.prototype.convert_to_accessors=function(e){var n={};return t.utils.objectForEach(e,function(r,i){i instanceof l?(e[r]=function(){return i.get_value()},t.expressionRewriting._twoWayBindings[r]&&(n[r]=function(t){i.set_value(t)})):i instanceof g?e[r]=function(){return i.get_value()}:"function"!=typeof i&&(e[r]=function(){return i})}),Object.keys(n).length>0&&(e._ko_property_writers=function(){return n}),e},e.prototype.parse=function(t){return this.text=(t||"").trim(),this.at=0,this.ch=" ",this.text?(result=this.bindings(),this.white(),this.ch&&this.error("Syntax Error"),this.convert_to_accessors(result)):null},e}(),t.utils.extend(u.prototype,{registerBindings:h,nodeHasBindings:c,getBindingAccessors:d,getBindingsString:a,nodeParamsToObject:p,Parser:x}),e||(t.secureBindingsProvider=u),u});